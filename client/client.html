<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" type="text/css" href="/style.css">

  <title>Coffee Writings</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
  <script type="text/babel">

    const createDrinkDisplay = (drinkArray, content) => {
      drinkArray.forEach(drink => {
         const drinkName = document.createElement('h2');
         const drinkDate = document.createElement('p');
         const drinkCafe = document.createElement('h3');
         const drinkDesc = document.createElement('p');
         const drinkCost = document.createElement('p');
         const drinkRating = document.createElement('p');

         const drinkDiv = document.createElement('div');
         drinkDiv.style.backgroundColor = "white";
         drinkDiv.style.border = "1px solid black";
         drinkDiv.style.width = "40vw";
         drinkDiv.style.margin = "5vh 20vw";
         drinkDiv.style.padding = "1em";

         drinkName.textContent = drink.name;
         drinkDiv.appendChild(drinkName);

         drinkCafe.textContent = `Cafe: ${drink.cafe}`;
         drinkDiv.appendChild(drinkCafe);

         if(drink.date) {
          drinkDate.textContent = drink.date;
          drinkDiv.appendChild(drinkDate);
         };

         drinkDesc.textContent = drink.description;
         drinkDiv.appendChild(drinkDesc);

         drinkCost.textContent = `Cost: ${drink.cost}`;
         drinkDiv.appendChild(drinkCost);

         if(drink.rating) {
          drinkRating.textContent = `Rating: ${drink.rating}`;
          drinkDiv.appendChild(drinkRating);
         };

         content.appendChild(drinkDiv);
    });
  };

    const parseJSON = (xhr, content) => {
      if(xhr.response) {
        const obj = JSON.parse(xhr.response);
        console.dir(`obj: ${obj}`);
        console.dir(xhr.response);
      
      //if message in response, add to screen
      if(obj.message) {
        const p = document.createElement('p');
        p.textContent = `Message: ${xhr.response}`;
        content.appendChild(p);
      }
      
      //if users in response, add to screen
      if(obj.faveDrinks) {     
        console.log('in fave drinks');

        if(obj.faveDrinks.length == 0) {
          alert('No drinks added to favorites!');
        } else {
        createDrinkDisplay(obj.faveDrinks, content);
      };
    }
      if(obj.allDrinks) {
        // const drinks = JSON.stringify(obj.allDrinks.coffee[0]);
        console.dir(obj.allDrinks.coffee);
        createDrinkDisplay(obj.allDrinks.coffee, content);
       };
    };
    };
  
    const handleResponse = (xhr) => {
      const content = document.querySelector('#output');
      //check the status code
      switch(xhr.status) {
        case 200: //success
          content.innerHTML = `<b>Success</b>`;
          break;
        case 201: //created
          content.innerHTML = '<b>Create</b>';
          break;
        case 204: //updated (no response back from server)
          content.innerHTML = '<b>Updated (No Content)</b>';
          break;
        case 400: 
          alert("All fields are required");
          break;
        case 404: //updated (no response back from server)
          //content.innerHTML = '<b>Resource Not Found</b>';
          alert("Resource not found");
          break;
        case 500: 
          alert("Internal Server Error");
          break;
        default: //any other status code
          alert("Error: Code not implemented by client");  
        //content.innerHTML = `Error code not implemented by client.`;
          break;
      }
      parseJSON(xhr, content);
    };
  
    const sendPost = (e, drinkForm) => {
      const drinkAction = drinkForm.getAttribute('action');
      const drinkMethod = drinkForm.getAttribute('method');
      
      const drinkField = drinkForm.querySelector('#drinkField');
      const dateField = drinkForm.querySelector('#dateField');
      const cafeField = drinkForm.querySelector('#cafeField');
      const descField = drinkForm.querySelector('#descField');
      const costField = drinkForm.querySelector('#costField');
      const ratingField = drinkForm.querySelector('#ratingField');
      
      const xhr = new XMLHttpRequest();
      xhr.open(drinkMethod, drinkAction);
  
      xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
      xhr.setRequestHeader ('Accept', 'application/json');
      
      xhr.onload = () => handleResponse(xhr);
      
      const formData = `name=${drinkField.value}&date=${dateField.value}&cafe=${cafeField.value}&description=${descField.value}&cost=${costField.value}&rating=${ratingField.value}`;
      
      xhr.send(formData);
      console.dir(`form data: ${formData}`);
    
      e.preventDefault();
      return false;
    };

    const showForm = () => {
      const addDrinkForm = document.querySelector("#addDrinkForm");
      const drinkList = document.querySelector("#drinkLists");
      const outputContent = document.querySelector("#output");


      if(addDrinkForm.style.display === "none") {
        addDrinkForm.style.display = "block";
        //drinkContent.innerHTML = "";
        drinkList.style.display = "none";
      }
    }
  
    const requestUpdate = (e, method) => {
      const addDrinkForm = document.querySelector("#addDrinkForm");
      const drinkContent = document.querySelector("#drinkLists");

        addDrinkForm.style.display = "none";
        drinkContent.style.display = "block";
      // const url = userForm.querySelector('#urlField').value;
      // const method = userForm.querySelector('#methodSelect').value;
      
      const xhr = new XMLHttpRequest();
      xhr.open('get', method);
      
      xhr.setRequestHeader('Accept', 'application/json');
      if(method == 'get') {
        xhr.onload = () => handleResponse(xhr, true);
      } else {
        xhr.onload = () => handleResponse(xhr, false);
      }
      xhr.send();
      
      e.preventDefault();
      return false;
    };

    const sortResponses = () => {
      const filterValue = document.querySelector("#sortSelect").value;
      console.log(`sort responses ${filterValue}`);
    };
  
    const init = () => {   
      const drinkForm = document.querySelector('#addDrinkForm');
      const getDrinkButton = document.querySelector('#seeDrinks');
      const allDrinkButton = document.querySelector('#allDrinks');

      const sortButton = document.querySelector('#sortSelectButton');
      sortButton.addEventListener('click', sortResponses);

      const showFormButton = document.querySelector('#newDrink');
      showFormButton.addEventListener('click', showForm);
      
      //create handler
      const addDrink = (e) => sendPost(e, drinkForm);
      const getDrink = (e) => requestUpdate(e, '/getDrinks');
      const allDrink = (e) => requestUpdate(e, '/allDrinks');

      //attach submit event (for clicking submit or hitting enter)
      drinkForm.addEventListener('submit', addDrink);
      getDrinkButton.addEventListener('click', getDrink);
      allDrinkButton.addEventListener('click', allDrink);
    };
  
    window.onload = init;
    </script>
</head>

<body>
  <nav>
    <div id="logo">
      <h1>Coffee Writings</h1>
    </div>
    <div id="navLinks">
      <button id="newDrink">New Drink</button>
      <button id="seeDrinks">My Drinks</button>
      <button id="allDrinks">All Drinks</button>
    </div>
  </nav>
  <content>
    <form id="addDrinkForm" action="/addDrink" method="post">
      <div class="formItem">
        <label for="drink">Drink: </label>
        <input id="drinkField" type="text" name="drink" />
      </div>
      <div class="formItem">
        <label for="date">Date: </label>
        <input id="dateField" type="date" name="date" />
      </div>
      <div class="formItem">
        <label for="cafeName">Cafe Name: </label>
        <input id="cafeField" type="text" name="cafeName" />
      </div>
      <div class="formItem">
        <label for="description">Description: </label>
        <textarea id="descField" type="text" name="description" cols="50" rows="5"></textarea>
      </div>
      <div class="formItem">
        <label for="cost">Cost: </label>
        <input id="costField" type="number" name="cost" min="0.00" max="10000" step="0.01" />
      </div>
      <div class="formItem">
        <label for="rating">Rating (0 - 10): </label>
        <input id="ratingField" type="number" name="rating" min="0" max="10" step="1" />
      </div>
      <input type="submit" value="Save to Favorites" />
    </form>
  </content>
  <section id="drinkLists">
      <div id="sortField">
          <select id="sortSelect">
            <option value="lowPrice">Cost (Low to high)</option>
            <option value="highPrice">Cost (High to Low)</option>
            <option value="name">Name</option>
            <option value="rating">Rating</option>
          </select>
          <button id="sortSelectButton">Filter</button>
        </div>
    <div id="output"></div>
  </section>
</body>

</html>