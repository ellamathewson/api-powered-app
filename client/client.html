<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" type="text/css" href="/style.css">

  <title>Coffee Writings</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
  <script type="text/babel">
    const parseJSON = (xhr, content) => {
      if(xhr.response) {
        console.dir('in xhr response');
        const obj = JSON.parse(xhr.response);
        console.dir(obj);
      
      //if message in response, add to screen
      if(obj.message) {
        console.dir('have object')
        const p = document.createElement('p');
        p.textContent = `Message: ${xhr.response}`;
        content.appendChild(p);
      }
      
      //if users in response, add to screen
      if(obj.faveDrinks) {
        // let drinks = [];
        // for(let d in obj.faveDrinks) {
        //   drinks.push(d);
        // }

        // for(let i = 0; i < drinks.length; i++) {
        //   const drinkDiv = document.createElement('div');
        //   const drinkHeader = document.createElement('h1');
        //   const stringDrink = JSON.stringify(drinks[i]);
        //   drinkHeader.textContent = stringDrink;
        //   content.appendChild(drinkDiv);
        //   content.appendChild(drinkHeader);
        // }

        // console.dir('in object');
        const drinkList = document.createElement('p');
        const drinks = JSON.stringify(obj.faveDrinks);
        drinkList.textContent = drinks;
        console.dir(drinkList);
        content.appendChild(drinkList); 
      }

      if(obj.allDrinks) {
        const drinkList = document.createElement('p');
        const drinks = JSON.stringify(obj.allDrinks);
        drinkList.textContent = drinks;
        console.dir(drinkList);
        content.appendChild(drinkList); 
      }
    }
    };
  
    const handleResponse = (xhr) => {
      const content = document.querySelector('#contentResponse');
      //check the status code
      switch(xhr.status) {
        case 200: //success
          content.innerHTML = `<b>Success</b>`;
          break;
        case 201: //created
          content.innerHTML = '<b>Create</b>';
          break;
        case 204: //updated (no response back from server)
          content.innerHTML = '<b>Updated (No Content)</b>';
          break;
        case 404: //updated (no response back from server)
          content.innerHTML = '<b>Resource Not Found</b>';
          break;
        default: //any other status code
          content.innerHTML = `Error code not implemented by client.`;
          break;
      }
      parseJSON(xhr, content);
    };
  
    const sendPost = (e, drinkForm) => {
      const drinkAction = drinkForm.getAttribute('action');
      const drinkMethod = drinkForm.getAttribute('method');
      
      const drinkField = drinkForm.querySelector('#drinkField');
      const dateField = drinkForm.querySelector('#dateField');
      const cafeField = drinkForm.querySelector('#cafeField');
      const descField = drinkForm.querySelector('#descField');
      const costField = drinkForm.querySelector('#costField');
      const ratingField = drinkForm.querySelector('#ratingField');
      
      const xhr = new XMLHttpRequest();
      xhr.open(drinkMethod, drinkAction);
  
      xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
      xhr.setRequestHeader ('Accept', 'application/json');
      
      xhr.onload = () => handleResponse(xhr);
      
      const formData = `name=${drinkField.value}&date=${dateField.value}&cafe=${cafeField.value}&description=${descField.value}&cost=${costField.value}&rating=${ratingField.value}`;
      
      xhr.send(formData);
      console.dir(formData);
    
      e.preventDefault();
      return false;
    };
  
    const requestUpdate = (e, method) => {
      // const url = userForm.querySelector('#urlField').value;
      // const method = userForm.querySelector('#methodSelect').value;
      
      const xhr = new XMLHttpRequest();
      xhr.open('get', method);
      
      xhr.setRequestHeader('Accept', 'application/json');
      //if(method == 'get') {
        xhr.onload = () => handleResponse(xhr, true);
      // } else {
      //   xhr.onload = () => handleResponse(xhr, false);
      // }
      xhr.send();
      
      e.preventDefault();
      return false;
    };
  
    const init = () => {   
      const drinkForm = document.querySelector('#addDrinkForm');
      const getDrinkButton = document.querySelector('#seeDrinks');
      const allDrinkButton = document.querySelector('#allDrinks');
      
      //create handler
      const addDrink = (e) => sendPost(e, drinkForm);
      const getDrink = (e) => requestUpdate(e, '/getDrinks');
      const allDrink = (e) => requestUpdate(e, '/allDrinks');

      //attach submit event (for clicking submit or hitting enter)
      drinkForm.addEventListener('submit', addDrink);
      getDrinkButton.addEventListener('click', getDrink);
      allDrinkButton.addEventListener('click', allDrink);

    };
  
    window.onload = init;
    </script>
</head>
<body>
  <nav>
    <div id="logo">
        <h1>Coffee Writings</h1>
    </div>
    <div id="navLinks">
      <button id="seeDrinks">My Drinks</button>
      <button id="allDrinks">All Drinks</button>
    </div>
</nav>

<content>
  <form id="addDrinkForm" action="/addDrink" method="post">
      <div class="formItem">
      <label for="drink">Drink: </label>
      <input id="drinkField" type="text" name="drink" />
  </div>
  <div class="formItem">
    <label for="date">Date: </label>
    <input id="dateField" type="date" name="date" />
</div>
  <div class="formItem">
      <label for="cafeName">Cafe Name: </label>
      <input id="cafeField" type="text" name="cafeName" />
  </div>
  <div class="formItem">
      <label for="description">Description: </label>
      <textarea id="descField" type="text" name="description" cols="50" rows="5"></textarea>
  </div>
  <div class="formItem">
      <label for="cost">Cost: </label>
      <input id="costField" type="number" name="cost" min="0.00" max="10000" step="0.01"/>
  </div>
  <div class="formItem">
    <label for="rating">Rating (0 - 10): </label>
    <input id="ratingField" type="number" name="rating" min="0" max="10" step="1"/>
</div>
      <input type="submit" value="Save to Favorites"/>
  </form>
</content>
<section id="contentResponse"></section>
</body>
</html>